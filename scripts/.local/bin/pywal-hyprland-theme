#!/usr/bin/env bash

set -euo pipefail

HYPRPAPER_CONF="$HOME/.config/hypr/hyprpaper.conf"
HYPR_COLORS="$HOME/.config/hypr/modules/colors-tokyonight.conf"
WAYBAR_COLORS="$HOME/.config/waybar/colors-tokyonight.css"
ROFI_COLORS="$HOME/.config/rofi/shared/colors.rasi"
DUNST_CONF="$HOME/.config/dunst/dunstrc"

if ! command -v wal >/dev/null 2>&1; then
  echo "pywal (wal) is not installed." >&2
  exit 1
fi

if [ ! -f "$HYPRPAPER_CONF" ]; then
  echo "Missing hyprpaper config: $HYPRPAPER_CONF" >&2
  exit 1
fi

CURRENT_WALLPAPER=$(awk -F'=' '/^[[:space:]]*path[[:space:]]*=/ {gsub(/^[[:space:]]+|[[:space:]]+$/, "", $2); print $2; exit}' "$HYPRPAPER_CONF")
if [ -n "$CURRENT_WALLPAPER" ]; then
  WALLPAPER_DIR=$(dirname "$CURRENT_WALLPAPER")
else
  WALLPAPER_DIR="$HOME/Pictures/Wallpaper"
fi

MONITOR=$(awk -F'=' '/^[[:space:]]*monitor[[:space:]]*=/ {gsub(/^[[:space:]]+|[[:space:]]+$/, "", $2); print $2; exit}' "$HYPRPAPER_CONF")
MONITOR=${MONITOR:-eDP-1}

WALLPAPER=$(find "$WALLPAPER_DIR" -type f \( -iname '*.jpg' -o -iname '*.png' -o -iname '*.jpeg' -o -iname '*.webp' \) | shuf -n 1)
if [ -z "$WALLPAPER" ]; then
  echo "No wallpapers found in $WALLPAPER_DIR" >&2
  exit 1
fi

sed -i -E "s|^[[:space:]]*path[[:space:]]*=.*|    path = $WALLPAPER|" "$HYPRPAPER_CONF"

if ! hyprctl hyprpaper wallpaper "$MONITOR,$WALLPAPER" >/dev/null 2>&1; then
  HYPRPAPER_PID=$(pidof hyprpaper || true)
  if [ -n "$HYPRPAPER_PID" ]; then
    kill $HYPRPAPER_PID
    sleep 0.2
  fi
  hyprpaper &
  disown
  sleep 0.5
  if ! hyprctl hyprpaper wallpaper "$MONITOR,$WALLPAPER" >/dev/null 2>&1; then
    echo "Failed to set wallpaper via hyprctl." >&2
  fi
fi

wal -i "$WALLPAPER" --backend auto --saturate 0.8

# shellcheck disable=SC1090
source "$HOME/.cache/wal/colors.sh"

cat >"$HYPR_COLORS" <<EOF

general {
    gaps_in = 5
    gaps_out = 15
    border_size = 2
    col.active_border = rgb(${color4:1}) rgb(${color5:1}) 45deg
    col.inactive_border = rgb(${color0:1})
    resize_on_border = true
    allow_tearing = false
    layout = dwindle
}

decoration {
    rounding = 10
    rounding_power = 2
    active_opacity = 0.80
    inactive_opacity = 0.30
    shadow {
        enabled = true
        range = 20
        render_power = 3
        color = rgba(${color0:1}aa)
    }
    blur {
        enabled = true
        size = 8
        passes = 3
        new_optimizations = true
        vibrancy = 0.1696
    }
}

dwindle {
    pseudotile = true
    preserve_split = true
}

master {
    new_status = master
}

misc {
    force_default_wallpaper = 1
    disable_hyprland_logo = true
}
EOF

cat >"$WAYBAR_COLORS" <<EOF
/* Generated by pywal-hyprland-theme */

@define-color base   ${background};
@define-color mantle ${color0};
@define-color crust  ${color8};

@define-color text     ${foreground};
@define-color subtext0 ${color7};
@define-color subtext1 ${color6};

@define-color surface0 ${color0};
@define-color surface1 ${color8};
@define-color surface2 ${color2};

@define-color overlay0 ${color8};
@define-color overlay1 ${color7};
@define-color overlay2 ${color6};

@define-color blue      ${color4};
@define-color lavender  ${color5};
@define-color sapphire  ${color6};
@define-color sky       ${color6};
@define-color teal      ${color6};
@define-color green     ${color2};
@define-color yellow    ${color3};
@define-color peach     ${color11};
@define-color maroon    ${color1};
@define-color red       ${color1};
@define-color mauve     ${color5};
@define-color pink      ${color13};
@define-color flamingo  ${color9};
@define-color rosewater ${color15};
EOF

cat >"$ROFI_COLORS" <<EOF
* {
    background:     ${background}FF;
    background-alt: ${color0}FF;
    foreground:     ${foreground}FF;
    selected:       ${color4}FF;
    active:         ${color2}FF;
    urgent:         ${color1}FF;
}
EOF

awk -v bg="$background" -v fg="$foreground" -v hl="$color4" -v hl_crit="$color1" -v sep="$color0" '
    /^\[/ {section=$0}
    /^[[:space:]]*separator_color[[:space:]]*=/ {sub(/=.*/, "= \"" sep "\""); print; next}
    section=="[urgency_low]" && /^[[:space:]]*background[[:space:]]*=/ {sub(/=.*/, "= \"" bg "\""); print; next}
    section=="[urgency_low]" && /^[[:space:]]*foreground[[:space:]]*=/ {sub(/=.*/, "= \"" fg "\""); print; next}
    section=="[urgency_low]" && /^[[:space:]]*highlight[[:space:]]*=/ {sub(/=.*/, "= \"" hl "\""); print; next}
    section=="[urgency_normal]" && /^[[:space:]]*background[[:space:]]*=/ {sub(/=.*/, "= \"" bg "\""); print; next}
    section=="[urgency_normal]" && /^[[:space:]]*foreground[[:space:]]*=/ {sub(/=.*/, "= \"" fg "\""); print; next}
    section=="[urgency_normal]" && /^[[:space:]]*highlight[[:space:]]*=/ {sub(/=.*/, "= \"" hl "\""); print; next}
    section=="[urgency_critical]" && /^[[:space:]]*background[[:space:]]*=/ {sub(/=.*/, "= \"" bg "\""); print; next}
    section=="[urgency_critical]" && /^[[:space:]]*foreground[[:space:]]*=/ {sub(/=.*/, "= \"" fg "\""); print; next}
    section=="[urgency_critical]" && /^[[:space:]]*highlight[[:space:]]*=/ {sub(/=.*/, "= \"" hl_crit "\""); print; next}
    {print}
' "$DUNST_CONF" >"${DUNST_CONF}.tmp" && mv "${DUNST_CONF}.tmp" "$DUNST_CONF"

if command -v pywalfox >/dev/null 2>&1; then
  if ! pywalfox update; then
    echo "pywalfox update failed." >&2
  fi
fi

if ! hyprctl reload >/dev/null 2>&1; then
  echo "hyprctl reload failed." >&2
fi

WAYBAR_PID=$(pidof waybar || true)
if [ -n "$WAYBAR_PID" ]; then
  kill -SIGUSR2 $WAYBAR_PID
fi

DUNST_PID=$(pidof dunst || true)
if [ -n "$DUNST_PID" ]; then
  kill $DUNST_PID
fi

if command -v dunst >/dev/null 2>&1; then
  dunst -conf "$DUNST_CONF" &
  disown
fi

echo "Applied theme from $WALLPAPER"
